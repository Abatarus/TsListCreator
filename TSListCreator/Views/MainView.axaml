<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:v="using:TSListCreator.Views"
             xmlns:vm="using:TSListCreator.ViewModels"
             xmlns:controls="clr-namespace:TSListCreator.Controls"
             xmlns:converters="clr-namespace:TSListCreator.Converters" 
             xmlns:utils="clr-namespace:TSListCreator.Utils"
             d:DesignHeight="450"
             d:DesignWidth="800"
             x:DataType="vm:MainViewModel"
             x:Name="Main"
             mc:Ignorable="d"
             x:Class="TSListCreator.Views.MainView">
    <UserControl.Resources>
        <converters:CanvasCoorToTsPosConverter x:Key="CanvasCoorToTsPos"/>
    </UserControl.Resources>
    <Interaction.Behaviors>
        <EventTriggerBehavior EventName="SizeChanged" SourceObject="Main">
            <InvokeCommandAction Command="{Binding UpdateControls}"/>
        </EventTriggerBehavior>
    </Interaction.Behaviors>


    <Grid Background="#bdbdbd"
          ColumnDefinitions="*,Auto,*, Auto">
        <StackPanel Grid.Column="1">
            <Image x:Name="ShowedImage"
                   HorizontalAlignment="Center"
                   Stretch="Uniform"
                   Height="{Binding $parent.Bounds.Height}"
                   Bounds="{Binding TsImage.Bounds, Mode=OneWayToSource}"
                   Source="{Binding TsImage.Source}"/>
        </StackPanel>
        <ItemsControl Grid.Column="1"
                      HorizontalAlignment="Stretch"
                      VerticalAlignment="Stretch"
                      ItemsSource="{Binding SharedCollection, Mode=TwoWay}">
            <ItemsControl.Styles>
                <Style Selector="ContentPresenter"
                       x:DataType="controls:TsControl">
                    <Setter Property="Canvas.Left"
                            Value="{Binding CanvasPosX}"/>
                    <Setter Property="Canvas.Top"
                            Value="{Binding CanvasPosY}"/>
                </Style>
            </ItemsControl.Styles>
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <Canvas x:Name="Canvas"
                            Background="Transparent"
                            PointerMoved="OnPointerMoved"
                            PointerPressed="OnPointerPressed"
                            PointerReleased="OnPointerReleased">
                    </Canvas>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>

            <ItemsControl.ItemTemplate>
                <utils:CanvasTemplateSelector>
                    <DataTemplate x:Key="TsTextBox">
                        <v:TextBoxCanvasView/>
                    </DataTemplate>
                    <DataTemplate x:Key="TsCounter">
                        <v:CounterCanvasView/>
                    </DataTemplate>
                    <DataTemplate x:Key="TsCheckBox">
                        <v:CheckBoxCanvasView/>
                    </DataTemplate>
                </utils:CanvasTemplateSelector>
            </ItemsControl.ItemTemplate>

        </ItemsControl>
        <Grid Grid.Column="3"
              Background="#eaede8"
              RowDefinitions="*,Auto,Auto,Auto,Auto">
            <TabControl Grid.Row="0">
                <TabItem Header="Поля ввода">
                    <Grid RowDefinitions="Auto, *">
                        <Button Grid.Row="0"
                                HorizontalAlignment="Stretch"
                                Content="Добавить"
                                Command="{Binding AddNewTextBox}"
                                IsEnabled="{Binding CanAdd}" />
                        <ScrollViewer Grid.Row="1">
                            <ItemsControl ItemsSource="{Binding TextBoxes, Mode=TwoWay}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <v:TextBoxListView/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </TabItem>
                <TabItem Header="Счетчики">
                    <Grid RowDefinitions="Auto, *">
                        <Button Grid.Row="0"
                                HorizontalAlignment="Stretch"
                                Content="Добавить"
                                Command="{Binding AddNewCounter}"
                                IsEnabled="{Binding CanAdd}" />
                        <ScrollViewer Grid.Row="1">
                            <ItemsControl ItemsSource="{Binding Counters, Mode=TwoWay}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <v:CounterListView/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </TabItem>
                <TabItem Header="Галочки">
                    <Grid RowDefinitions="Auto, *">
                        <Button Grid.Row="0"
                                HorizontalAlignment="Stretch"
                                Content="Добавить"
                                Command="{Binding AddNewCheckBox}"
                                IsEnabled="{Binding CanAdd}" />
                        <ScrollViewer Grid.Row="1">
                            <ItemsControl ItemsSource="{Binding CheckBoxes, Mode=TwoWay}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <v:CheckBoxListView/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </TabItem>
                <TabItem Header="Настройки">
                    <ScrollViewer>
                        <v:SettingsView DataContext="{Binding Settings}"/>
                    </ScrollViewer>
                </TabItem>
            </TabControl>
            <Button x:Name="LoadImageButton"
                    Grid.Row="1"
                    HorizontalAlignment="Stretch"
                    Command="{Binding LoadImage}"
                    Content="Выбрать изображение" />
            <Button Name="LoadDataButton"
                    Grid.Row="2"
                    HorizontalAlignment="Stretch"
                    Content="Загрузить"
                    Command="{Binding Load}"
                    IsEnabled="{Binding CanInteract}" />
            <Button x:Name="SaveButton"
                    Grid.Row="3"
                    HorizontalAlignment="Stretch"
                    Content="Сохранить"
                    Command="{Binding Save}"
                    IsEnabled="{Binding CanInteract}" />
            <Button x:Name="CopyClipboard"
                    Grid.Row="4"
                    HorizontalAlignment="Stretch"
                    Content="Копировать в буфер обмена"
                    Command="{Binding CopyToClipBoard}"
                    IsEnabled="{Binding CanInteract}" />
        </Grid>
    </Grid>
</UserControl>

